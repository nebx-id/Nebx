name: Publish Changed Libraries

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # REQUIRED for pushing tags

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for MinVer

      - name: Setup .NET SDKs (8 and 10)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      # -------------------------------
      # Detect changed project folders
      # -------------------------------
      - name: Detect changed projects
        id: detect
        run: |
          echo "Detecting changed project files..."

          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)

          PROJECTS=""
          for file in $CHANGED_FILES; do
            DIR=$(dirname "$file")
            PROJ=$(find "$DIR" -maxdepth 1 -name '*.csproj' | head -n 1 || true)

            if [ -n "$PROJ" ]; then
              PROJECTS="$PROJECTS $PROJ"
            fi
          done

          # Deduplicate
          UNIQUE=$(echo "$PROJECTS" | tr ' ' '\n' | sort -u | tr '\n' ' ')
          echo "projects=$UNIQUE" >> $GITHUB_OUTPUT

      - name: Display detected projects
        run: |
          echo "Detected projects: '${{ steps.detect.outputs.projects }}'"

      # -------------------------------------
      # Pack only changed project(s)
      # -------------------------------------
      - name: Pack projects
        if: ${{ steps.detect.outputs.projects != '' }}
        run: |
          mkdir -p artifacts
          for proj in ${{ steps.detect.outputs.projects }}; do
            echo "Packing: $proj"
            dotnet pack "$proj" -c Release -o ./artifacts
          done

      # -------------------------------------
      # Publish to NuGet
      # -------------------------------------
      - name: Publish to NuGet.org
        if: ${{ steps.detect.outputs.projects != '' }}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
            --source https://api.nuget.org/v3/index.json \
            --api-key "$NUGET_API_KEY" \
            --skip-duplicate

      # -------------------------------------
      # Extract semantic version from MinVer
      # -------------------------------------
      - name: Extract version
        if: ${{ steps.detect.outputs.projects != '' }}
        id: version
        run: |
          version=$(dotnet minver)
          echo "version=$version" >> $GITHUB_OUTPUT

      # -------------------------------------
      # Create and push Git tag
      # (Works reliably in 2025)
      # -------------------------------------
      - name: Create Git Tag
        if: ${{ steps.detect.outputs.projects != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.version }}"

          echo "Creating tag: $TAG"
          git tag "$TAG"

          echo "Pushing tag via authenticated URL..."
          git push \
            https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git \
            "$TAG"
