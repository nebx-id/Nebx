name: Publish All Libraries

on:
  push:
    branches: [ main ]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for pushing git tags

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required for MinVer

      - name: Setup .NET SDKs (8 and 10)
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: |
            8.0.x
            10.0.x

      # --------------------------------
      # Pack ALL projects in the repo
      # --------------------------------
      - name: Find & Pack all projects
        run: |
          mkdir -p artifacts

          for proj in $(find . -name '*.csproj'); do
            echo "Packing: $proj"
            dotnet pack "$proj" -c Release -o ./artifacts
          done

      # --------------------------------
      # Publish all packages
      # --------------------------------
      - name: Publish packages to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push "./artifacts/*.nupkg" \
            --source https://api.nuget.org/v3/index.json \
            --api-key "$NUGET_API_KEY" \
            --skip-duplicate

      # --------------------------------
      # Calculate version using MinVer
      # --------------------------------
      - name: Extract version via MinVer
        id: version
        run: |
          version=$(dotnet minver)
          echo "version=$version" >> $GITHUB_OUTPUT

      # --------------------------------
      # Create + push Git tag
      # --------------------------------
      - name: Create Git Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          echo "Creating tag: $TAG"

          git tag "$TAG"
          git push \
            https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git \
            "$TAG"
